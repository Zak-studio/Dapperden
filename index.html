<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dapperden</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        /* ... (keep all your existing styles the same) ... */
    </style>
</head>
<body>
    <!-- ... (keep all your existing HTML the same) ... -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const imageInput = document.getElementById('imageInput');
        const downloadButton = document.getElementById('downloadButton');
        const cropModal = document.getElementById('cropModal');
        const imageToCrop = document.getElementById('imageToCrop');
        const downloadStatus = document.getElementById('downloadStatus');

        let uploadedImage = null;
        let frameImage = null;
        let cropper = null;
        let downloadUrl = '';

        // Load the default static frame from the GitHub repository
        frameImage = new Image();
        frameImage.src = './frame.png';

        function resizeCanvas() {
            // Set the actual canvas resolution to 2160x3840px (9:16)
            canvas.width = 2160;
            canvas.height = 3840;
        }

        resizeCanvas();

        window.addEventListener('resize', () => {
            if (uploadedImage) generatePoster();
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imageToCrop.src = event.target.result;
                    cropModal.style.display = 'flex';
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 1.0,
                        movable: true,
                        zoomable: true,
                        scalable: true,
                        rotatable: true,
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        function rotateLeft() {
            if (cropper) cropper.rotate(-90);
        }

        function rotateRight() {
            if (cropper) cropper.rotate(90);
        }

        function closeCropModal() {
            cropModal.style.display = 'none';
            if (cropper) cropImage();
        }

        function cropImage() {
            if (cropper) {
                const croppedCanvas = cropper.getCroppedCanvas({
                    width: 1728,
                    height: 1728,
                    minWidth: 1728,
                    minHeight: 1728,
                    maxWidth: 1728,
                    maxHeight: 1728,
                    fillColor: '#fff'
                });
                uploadedImage = new Image();
                uploadedImage.src = croppedCanvas.toDataURL('image/png');
                uploadedImage.onload = () => {
                    cropModal.style.display = 'none';
                    cropper.destroy();
                    cropper = null;
                    generatePoster();
                };
            }
        }

        function generatePoster() {
            if (!uploadedImage) {
                alert('Please upload an image first!');
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Define the photo area (1728x1728px)
            const photoAreaWidth = 1728;
            const photoAreaHeight = 1728;
            const photoAreaX = (canvas.width - photoAreaWidth) / 2; // Center horizontally: 216px
            
            // Position the photo lower (increased from 400 to 500px from the top)
            const photoAreaY = 500; 

            // Draw the uploaded photo
            ctx.drawImage(uploadedImage, photoAreaX, photoAreaY, photoAreaWidth, photoAreaHeight);

            // Draw the default static frame over the photo
            if (frameImage.complete && frameImage.naturalWidth !== 0) {
                ctx.drawImage(frameImage, 0, 0, canvas.width, canvas.height);
            }

            // Enable download at full resolution (2160x3840px)
            downloadUrl = canvas.toDataURL('image/png');
            downloadButton.style.display = 'block';
            downloadButton.onclick = () => {
                downloadStatus.style.display = 'flex';
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = 'poster.png';
                    link.onclick = () => {
                        setTimeout(() => {
                            downloadStatus.style.display = 'none';
                        }, 1000);
                    };
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    setTimeout(() => {
                        downloadStatus.style.display = 'none';
                    }, 3000);
                }, 100);
            };
        }
    </script>
</body>
</html>
